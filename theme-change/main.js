const { Plugin, Menu, MenuItem, MenuSeparator } = require('siyuan');
const axios = require('axios');

class ThemeChange extends Plugin {
    themeChangeButton = null;
    svg =
'<svg t="1682427859214" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2321" width="200" height="200"><path d="M1012.872533 322.1504l-0.1024-0.580267c-0.1024-0.682667-0.1024-2.491733-0.1024-3.4816v-1.365333l-1.877333-8.4992-0.238933-0.682667c-6.417067-18.670933-17.681067-30.242133-25.9072-38.6048l-5.9392-6.144a288.494933 288.494933 0 0 0-20.036267-20.514133c-5.768533-5.461333-11.1616-10.5472-16.725333-16.554667l-0.2048-0.238933-146.056534-146.0224-1.536-1.570133c-7.645867-7.953067-16.384-16.896-29.218133-23.688534-13.9264-7.714133-31.197867-9.284267-52.872533-9.284266-1.194667 0-4.437333 0-8.874667-0.136534-9.6256-0.1024-24.098133-0.341333-35.84-0.341333-13.7216 0-17.476267 0.238933-19.3536 0.580267a116.667733 116.667733 0 0 0-17.408 5.12l-1.262933 0.4096-18.7392 12.8-0.2048 0.136533c-8.533333 6.485333-14.1312 14.267733-18.261334 20.036267l-0.4096 0.580266-0.136533 0.238934a49.5616 49.5616 0 0 1-3.9936 5.2224c-14.916267 12.219733-25.224533 15.633067-54.203733 21.845333l-0.341334 0.136533-0.341333 0.1024c-4.744533 1.365333-8.533333 1.467733-10.1376 1.570134l-17.749333-0.887467c-15.223467-2.9696-26.624-5.666133-36.2496-9.966933l-0.341334-0.136534c-8.3968-3.413333-16.827733-9.6256-19.592533-13.346133l-1.4336-1.9456a117.248 117.248 0 0 0-22.357333-24.4736c-7.2704-6.144-22.186667-14.404267-31.505067-16.315733-6.997333-1.501867-18.056533-2.2528-33.518933-2.2528-25.122133 0-53.009067 1.911467-54.237867 2.048l-0.989867 0.068266-24.9856 6.382934-0.785066 0.341333c-16.725333 6.792533-28.228267 18.568533-35.84 26.385067L88.3712 234.564267c-4.539733 4.096-8.533333 8.192-12.356267 12.151466-3.310933 3.413333-6.519467 6.656-11.0592 10.8544C51.438933 269.482667 31.061333 287.470933 24.849067 320.853333c-3.515733 18.773333 3.584 35.4304 7.441066 44.407467l0.238934 0.443733c6.9632 15.9744 17.681067 26.146133 25.429333 33.621334l1.467733 1.365333 0.546134 0.477867c1.194667 0.887467 2.8672 2.594133 4.096 3.857066l5.632 5.768534c5.5296 6.212267 11.502933 11.776 17.271466 17.237333l19.114667 19.592533 35.293867 34.679467 10.069333 10.308267c0.682667 0.682667 1.3312 1.467733 2.116267 2.1504 3.959467 4.096 8.840533 9.216 15.36 13.9264l0.238933 0.238933c14.472533 9.966933 32.529067 15.735467 49.4592 15.735467 7.509333 0 14.609067-1.024 21.0944-3.140267v348.706133c0 13.0048-0.068267 27.648 5.2224 41.5744 7.202133 19.0464 22.1184 33.450667 32.768 40.004267 17.442133 11.6736 38.8096 13.277867 59.392 13.277867h327.714133l29.559467 0.443733c24.439467 0 52.292267-1.365333 74.205867-18.2272 14.062933-11.025067 24.917333-29.013333 29.013333-48.196267l0.1024-0.546133 0.682667-5.666133v-0.580267c0.443733-30.685867 0.443733-60.381867 0.443733-91.648v-279.8592c12.629333 4.061867 26.043733 4.778667 39.0144 2.048 30.208-5.802667 49.493333-28.433067 60.962133-42.154667l92.842667-92.091733 2.56-3.310933 0.955733-1.467734c6.7584-9.045333 22.254933-30.378667 17.851734-61.064533l-0.136534-0.580267z m-165.717333 111.035733l-0.887467 1.024c-6.417067 7.2704-15.0528 17.237333-20.923733 18.363734a13.2096 13.2096 0 0 1-2.8672 0.341333c-4.642133 0-8.635733-3.2768-18.602667-12.9024l-32.085333-31.6416-42.5984 30.037333v362.120534c0 14.848-0.1024 29.866667-0.238933 44.509866-0.1024 13.7216-0.170667 27.7504-0.170667 41.5744a19.968 19.968 0 0 1-2.798933 4.1984c-4.778667 3.413333-23.7568 3.857067-31.744 3.857067l-338.1248-0.443733-18.773334 0.443733c-16.2816 0-20.821333-1.501867-21.9136-2.048a21.230933 21.230933 0 0 1-4.983466-5.5296c-0.682667-3.515733-0.682667-13.380267-0.682667-18.944v-430.421333l-47.104-28.330667-6.417067 7.509333c-5.8368 6.826667-11.776 13.5168-17.8176 20.138667l-0.238933 0.238933c-6.826667 7.338667-12.4928 13.243733-18.773333 15.735467h-0.443734a21.060267 21.060267 0 0 1-9.3184-3.072l-0.443733-0.3072-0.443733-0.238933a25.9072 25.9072 0 0 1-4.983467-4.744534 41.335467 41.335467 0 0 1-2.082133-2.286933l-46.250667-45.738667a377.173333 377.173333 0 0 1-18.705067-19.182933l-0.750933-0.785067-2.56-1.911466c-3.413333-2.833067-6.519467-6.144-9.762133-9.5232a61.678933 61.678933 0 0 0-3.515734-3.652267l-6.314666-6.894933-0.1024-0.1024c-2.56-2.628267-4.778667-4.881067-7.509334-7.168-5.973333-5.188267-8.0896-7.68-9.4208-10.615467a29.422933 29.422933 0 0 0-1.3312-3.652267 7.9872 7.9872 0 0 1-0.546133-1.467733c1.536-6.212267 5.5296-10.410667 17.92-21.742933l0.238933-0.238934 12.8-13.141333c1.4336-1.501867 3.003733-2.935467 4.642134-4.539733 1.911467-1.809067 3.754667-3.618133 5.870933-5.768534L264.874667 157.627733l27.989333-28.194133 0.341333-0.341333c8.772267-9.5232 10.410667-10.308267 14.7456-10.5472l13.277867-1.024h55.842133l0.887467 0.341333c1.024 0.341333 1.774933 0.580267 2.218667 0.9216l0.785066 0.341333 0.750934 0.238934a9.216 9.216 0 0 0 1.911466 0.546133c2.730667 2.730667 5.5296 6.007467 8.8064 10.5472l1.467734 1.911467 0.238933 0.238933c15.5648 20.1728 40.379733 32.085333 47.547733 35.2256l0.238934 0.1024c14.9504 6.2464 30.72 10.581333 53.111466 14.506667l0.443734 0.136533 16.042666 1.467733c3.1744 0.580267 6.621867 0.785067 10.376534 0.785067 7.0656 0 15.291733-0.9216 25.258666-2.935467 35.498667-7.031467 57.275733-14.404267 84.718934-36.488533a81.237333 81.237333 0 0 0 16.384-18.1248c1.4336-1.604267 2.6624-3.1744 3.754666-4.539733 0.1024-0.238933 0.341333-0.443733 0.546134-0.682667l6.621866-3.857067c1.1264-0.2048 2.56-0.443733 4.334934-0.887466h16.5888c2.56 0 5.2224-0.136533 7.748266-0.238934 2.6624-0.1024 5.461333-0.238933 8.192-0.238933h0.887467c5.3248-0.443733 10.717867-0.443733 16.384-0.443733 13.380267 0 18.807467 0.9216 20.48 1.2288 3.754667 2.286933 9.045333 7.748267 13.687467 12.458666l145.271466 144.827734c5.870933 6.485333 12.151467 12.458667 19.3536 19.285333 4.881067 4.5056 11.537067 10.752 16.725334 16.520533l0.238933 0.238934 6.621867 6.826666 0.238933 0.068267c4.1984 3.9936 6.587733 6.690133 8.260267 9.216l0.682666 4.608v0.238933c0.1024 0.443733 0.341333 1.570133-3.6864 7.133867l-90.9312 90.4192-3.072 3.754667z" p-id="2322"></path></svg>'
    constructor() {
        super();
    }

    onload() {
        this.themeChangeButton = document.createElement('button');
        this.themeChangeButton.setAttribute('aria-label', '切换主题');
        this.themeChangeButton.classList.add('toolbar__item', 'b3-tooltips', 'b3-tooltips__sw');
        this.themeChangeButton.insertAdjacentHTML('beforeend', this.svg);
        this.themeChangeButton.addEventListener('click', (event) => {
            const appearance = window.siyuan.config.appearance;
            const mode = appearance.mode === 0 ? 'light' : 'dark';
            const themes = mode === 'light' ? appearance.lightThemes : appearance.darkThemes;
            const m = new Menu('themeChangeButton');
            for (const theme of themes) {
                m.addItem(
                    new MenuItem({
                        label: theme,
                        click: () => this.useTheme(theme, mode),
                    })
                )
            }
            m.addSeparator()
            m.addItem(
                new MenuItem({
                    label: '试试手气~',
                    icon: 'iconRefresh',
                    click: () => this.random(mode),
                })
            )
            m.showAtMouseEvent(event);
            event.stopPropagation();            
        });
        clientApi.addToolbarRight(this.themeChangeButton);
    }

    onunload() {
        this.themeChangeButton.remove();
    }

    useTheme(theme, mode) {
        const appearance = window.siyuan.config.appearance;
        const current = mode === 'light' ? appearance.themeLight : appearance.themeDark;
        if (theme === current) {
            return;
        }
        const obj = {
            ...window.siyuan.config.appearance,
        };
        if (mode === 'light') {
            obj.themeLight = theme;
        } else {
            obj.themeDark = theme;
        }
        axios.post('/api/setting/setAppearance', obj).then(() => window.location.reload());
    }

    random(mode) {
        const appearance = window.siyuan.config.appearance;
        const current = mode === 'light' ? appearance.themeLight : appearance.themeDark;
        const themes = mode === 'light' ? [...appearance.lightThemes] : [...appearance.darkThemes];
        for (let i = 0; i < themes.length; i++) {
            if (themes[i] === current) {
                themes.splice(i, 1);
            }
        }
        if (themes.length === 0) {
            return;
        }
        const r = Math.floor(Math.random() * themes.length)
        this.useTheme(themes[r], mode);
    }
}

module.exports = {
    default: ThemeChange,
};
