"use strict";const a=require("siyuan"),d="toolbar__item b3-tooltips b3-tooltips__sw";class p extends a.Plugin{constructor(){super(),console.log(`[OpenDiary]: Start: ${new Date}`),this.openDiary=this.openDiary.bind(this),this.notebooks=[],this.selectFolded=!0}async onload(){let o=performance.now();await this.initDom(),await this.initSelectorOptions();let e=performance.now();console.log(`[OpenDiary]: onload, 耗时: ${e-o} ms`),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)})}async initDom(){this.openDiarySelector=document.createElement("select"),this.openDiarySelector.className=d,this.openDiarySelector.setAttribute("aria-label","打开指定的日记"),this.openDiarySelector.innerHTML="<空>",this.openDiarySelector.style.margin="0 0.5rem",this.openDiarySelector.style.padding="0 0.1rem",this.openDiarySelector.style.maxWidth="7rem",this.openDiarySelector.addEventListener("click",t=>{if(console.log("[OpenDiary] Event: click"),this.selectFolded)this.selectFolded=!1,this.updateDiaryStatus();else{let i=parseInt(t.target.value);this.openDiary(i),this.selectFolded=!0}}),this.openDiarySelector.addEventListener("blur",()=>{console.log("[OpenDiary] Event: blur"),this.selectFolded=!0}),a.clientApi.addToolbarRight(this.openDiarySelector);const o=5;let e=0;for(;e<o&&!await this.queryNotebooks();)await new Promise(i=>setTimeout(i,1e3)),e++}async initSelectorOptions(){console.log("[OpenDiary]: initSelectorOptions"),this.notebooks.length>0?await this.openDiary(0):console.log("打开默认日记失败"),this.openDiarySelector.innerHTML="",this.notebooks.forEach((o,e)=>{let t=document.createElement("option");t.value=e.toString(),t.innerText=o.name,this.openDiarySelector.appendChild(t)}),await this.updateDiaryStatus()}async updateAll(){await this.queryNotebooks(),await this.initSelectorOptions()}async openDiary(o){if(this.notebooks.length>0){let e=this.notebooks[o],t=c();console.log(`[OpenDiary]: Open ${e.name}${t}`);let i=await this.getDocsByHpath(t,e);if(i!=null&&i.length>0){let l=i[0].id;window.open(`siyuan://blocks/${l}`)}else{let n=await this.createDiary(e,t);window.open(`siyuan://blocks/${n}`)}}else console.log("[OpenDiary]: Can not open diary cause no notebook loaded")}async queryNotebooks(){try{let e=(await a.serverApi.lsNotebooks("")).notebooks;e=e.filter(i=>i.name!=="思源笔记用户指南"&&i.closed===!1);let t=e.map(i=>i.name);return console.log(`[OpenDiary]: Read all notebooks: ${t}`),this.notebooks=e,!0}catch(o){return console.log(o),!1}}async updateDiaryStatus(){console.log("[OpenDiary]: updateDiaryStatus");let o=c(),e=await this.getDocsByHpath(o);if(e!=null){let t=e.map(n=>n.box),i=t.length;this.notebooks.forEach((n,l)=>{if(t.includes(n.id)){let r=this.openDiarySelector.children[l];r.innerText=`√ ${n.name}`}else{let r=this.openDiarySelector.children[l];r.innerText=n.name}}),console.log(`'[OpenDiary]: 当前日记共 ${i} 篇`)}}async getDocsByHpath(o,e=null){let t=`select * from blocks where type='d' and hpath = '${o}'`;e!=null&&(t=`select * from blocks where type='d' and hpath = '${o}' and box = '${e.id}'`);let i=await a.serverApi.sql(t);return i.length>0?i:null}async createDiary(o,e){console.log(`[OpenDiary]: Try to create: ${o.name} ${e}`);let t=await a.serverApi.createDocWithMd(o.id,e,"");return console.log(`[OpenDiary]: Create new diary ${t}`),t}onunload(){console.log("[OpenDiary]: plugin unload"),this.openDiarySelector.remove()}}function c(){const s=new Date,o=s.getFullYear(),e=String(s.getMonth()+1).padStart(2,"0"),t=String(s.getDate()).padStart(2,"0"),i=`${o}-${e}-${t}`;return`/daily note/${o}/${e}/${i}`}module.exports=p;
